</sys/ports/Config/ports.mk.conf
# </sys/ports/Mk/newvars.mk  # For Aram

# for compatibility
BUILDFOR=$objtype
PORTID=`{echo $PORTNAME | md5sum}
PORTCAT=`{basename -d `{pwd} | sed 's,.*/,,'}
PORTNAME=$PORTCAT/`{basename `{pwd}}
files=`{pwd}/files

all:VQE: fetch build install

info:VQE:
	echo 'Name: ' $PORTNAME
	if(! ~ $VERSION 0){
		echo 'Port Version: ' $VERSION
	}
	echo 'Description: ' $DESCRIPTION
	echo 'Complain to: ' $OWNER

fetch:VQE:
	. /sys/ports/Config/ports.conf
	@{
		rfork ne
		mkdir -p work/
		cd work
		test -e .patched && rm .patched
		if(! ~ $#WEBSOURCE 0){
			{ webfs && hget $WEBSOURCE > $WORKFILE } || exit $status
		}
		if(! ~ $#9PSERVER 0){
			if(! ~ $#9PFILE 0){
				{ 9fs $9PSERVER && fcp $9PFILE $WORKFILE } || exit $status
			}
			if(! ~ $#9PDIR 0){
				{ 9fs $9PSERVER && dircp $9PDIR ./ } || exit $status
			}
		}
		if(! ~ $#EXTRACTCOMMAND 0){
			file=`{pwd}^/^$WORKFILE
			$EXTRACTCOMMAND $file || exit $status
		}
		if(! ~ $#HGSOURCE 0){
			@{
				rfork ne
				{ webfs && hg clone $HGSOURCE } || exit $status
				if(! ~ $#HGREV 0){
					hg up $HGREV
				}
			} || exit $status
		}
		exit ''
	}
	exit ''

patch:VQE:
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(test -e work/.patched){
		exit 'already patched'
	}
	for(p in `{ls $files/*.patch >[2]/dev/null}){
		@{ cd $BUILDPATH && apply $p } || exit 'applying '^$p^' failed'
	}
	if(! ~ $#PATCHES 0){
		dircp $PATCHES $BUILDPATH
	}
	touch work/.patched || exit $status

unpatch:VQE:
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(! test -e work/.patched){
		exit 'not patched'
	}
	for(p in `{ls $files/*.patch >[2]/dev/null}){
		@{ cd $BUILDPATH && unapply $p } || exit 'unapplying '^$p^' failed'
	}
	rm work/.patched || exit $status

build:VQE:
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(! ~ $#archmask 0){
		for(i in $archmask){
			if(~ $i $objtype){
				exit 'objtype '^$"objtype^' is not supported'
			}
		}
	}
	if(! ~ $#DEPS 0){
		echo 'installing dependencies...'
		for(i in $DEPS){
			if(! checkport $i){
				@{
					# hacky. plz fix.
					rfork nE
					PORTS=$PORTS
					home=$home
					objtype=$objtype
					cputype=$cputype
					cd $PORTS/$i
					mk fetch ; mk build ; mk install
				} || exit $status
			}
		}
	}
	if(! test -e work/.patched){
		mk patch || exit $status
	}
	cd $BUILDPATH
	@{
		rfork ne
		if(! ~ $BUILDCOMMAND ''){
			$BUILDCOMMAND
		}
		if not {
			status=''
		}
	}
	if(! ~ $#POSTBUILD 0){
		echo 'Running post-build hooks...'
		$POSTBUILD
	}
	exit ''

test:VQE: # build fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(! ~ $#archmask 0){
		for(i in $archmask){
			if(~ $i $objtype){
				exit 'objtype '^$"objtype^' is not supported'
			}
		}
	}
	@{
		rfork ne
		cd $BUILDPATH
		if(! ~ $#TESTCOMMAND 0){
			$TESTCOMMAND
			if(! ~ $status ''){
				echo 'Tests failed. Please notify '^$OWNER
				status='tests failed'
			}
			if not {
				echo 'Tests completed successfully!'
				status=''
			}
		}
		if not {
			echo 'tests aren''t supported on this port'
			status='no tests'
		}
	}
	exit ''

install:VQE: # build fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(! ~ $#BUILDONLY 0){
		for(i in $BUILDONLY){
			if(~ $i $objtype){
				exit 'objtype '^$"objtype^' is not supported.'
			}
		}
	}
	if(! checkport $PORTNAME){
		@{ rfork ne; cd $BUILDPATH && $INSTALLCOMMAND } || exit $status
		if(! ~ $#VERSION 0){
			register $PORTNAME $VERSION
		}
		if not {
			register $PORTNAME '0'
		}
		if(! ~ $#MESSAGE 0){
			for(i in $MESSAGE){
				echo $i
			}
		}
		if(! ~ $#MSGFILE 0){
			cat $MSGFILE
		}
	}
	if not {
		echo $PORTNAME is already installed
		status=''
	}
	exit ''

reinstall:VQE: # build fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	cd $BUILDPATH
	@{
		rfork ne
		$INSTALLCOMMAND
	}
	if(! ~ $*MESSAGE 0){
		for(i in $MESSAGE){
			echo $i
		}
	}
	exit ''

clean:VQE: # build fetch
	. /sys/ports/Config/ports.conf
	cd $BUILDPATH || exit notfetched
	if(! ~ $#CLEANCOMMAND 0){
		$CLEANCOMMAND || exit $status
	}
	exit ''

nuke:VQE:
	rm -rf work/

uninstall:VQE: # fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	if(! checkport $PORTNAME){
		echo $PORTNAME is not installed
		exit notinstalled
	}
	echo removing $PORTNAME...
	if(~ $#UNINSTALL 0 && ~ $#UNINSTALLCOMMAND 0){
		if(test -e $PORTS^$PORTNAME^'/uninstall'){
			UINSTALLCOMMAND=$PORTS^$PORTNAME^/'uninstall'
		}
		if not {
			echo 'unable to uninstall port'
			echo 'please send a bug report to '^$OWNER^' about this'
			echo 'If '^$OWNER^' does not respond or fix the port please'
			echo 'email mveety@gmail.com, and he will remove the port.'
			exit nouninstall
		}
	}
	if(~ $#UNINSTALLCOMMAND 0){
		for(i in $UNINSTALL){
			rm -f $i
		}
	}
	if not {
		@{ rfork ne; cd $BUILDPATH; $UNINSTALLCOMMAND } || exit $status
	}
	deregister $PORTNAME


</sys/ports/Config/ports.mk.conf

# for compatibility
BUILDFOR=$objtype
PORTID=`{echo $PORTNAME | md5sum}

all:VQE: fetch build install

info:VQE:
	echo 'Name: ' $PORTNAME
	if(! ~ $VERSION 0){
		echo 'Port Version: ' $VERSION
	}
	echo 'Description: ' $DESCRIPTION
	echo 'Complain to: ' $OWNER

fetch:VQE:
	. /sys/ports/Config/ports.conf
	touch fetch
	mkdir -p work/
	if(! ~ $#WEBSOURCE 0){
		@{
			rfork ne
			webfs
			hget $WEBSOURCE > work/$WORKFILE
			if(! ~ $#EXTRACTCOMMAND 0){
				EXTRACTCOMMAND=($EXTRACTCOMMAND `{pwd}^'/work/'^$WORKFILE)
				cd work
				$EXTRACTCOMMAND
			}
		}
	}
	if(! ~ $#CONTRIBSOURCE 0){
		9fs sources
		dircp $CONTRIBSOURCE work/
	}
	if(! ~ $#FCONTRIBSOURCE 0){
		9fs contrib.9front.org
		dircp $FCONTRIBSOURCE work/
	}
	if(! ~ $#HGSOURCE 0){
		webfs
		hg clone $HGSOURCE work/
	}
	status=''

build:VQE: fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	touch build
	if(! ~ $#DEPS 0){
		for(i in $DEPS){
			@{
				rfork ne
				if(! checkport $i){
					cd /sys/ports/$i
					mk fetch
					mk build
					mk install
				}
			}
		}
	}
	if(! ~ $#PATCHES 0){
		dircp $PATCHES $BUILDPATH
	}
	cd $BUILDPATH
	@{
		rfork ne
		if(! ~ $BUILDCOMMAND ''){
			$BUILDCOMMAND
		}
		if not {
			status=''
		}
	}

install:VQE: build fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	touch install
	if(! checkport $PORTNAME){
		cd $BUILDPATH
		@{
			rfork ne
			$INSTALLCOMMAND
		}
		if(! ~ $#VERSION 0){
			register $PORTNAME $VERSION
		}
		if not {
			register $PORTNAME '0'
		}
		if(! ~ $*MESSAGE 0){
			for(i in $MESSAGE){
				echo $i
			}
		}
	}

reinstall:VQE: build fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	cd $BUILDPATH
	@{
		rfork ne
		$INSTALLCOMMAND
	}
	if(! ~ $*MESSAGE 0){
		for(i in $MESSAGE){
			echo $i
		}
	}

clean:VQE: build fetch
	. /sys/ports/Config/ports.conf
	cd $BUILDPATH
	rm -f build fetch install
	if(! ~ $#CLEANCOMMAND 0){
		$CLEANCOMMAND
	}
	status=''

nuke:VQE:
	. /sys/ports/Config/ports.conf
	rm -f build fetch install
	rm -rf work/

uninstall:VQ: fetch
	. /sys/ports/Config/ports.conf
	. /sys/ports/Mk/pkg.rc
	rm -f build fetch install
	if(~ $#UNINSTALL 0 && ~ $#UNINSTALLCMD 0){
		if(test -e $PORTS^$PORTNAME^'/uninstall'){
			rc $PORTS^$PORTNAME^/'uninstall'
			deregister $PORTNAME
		}
		if not {
			echo 'unable to uninstall port'
			echo 'please send a bug report to '^$OWNER^' about this'
			echo 'If '^$OWNER^' does not respond or fix the port please'
			echo 'email mveety@gmail.com, and he will remove the port.'
		}
	}
	if not {
		if(~ $#UNINSTALLCMD 0){
			for(i in $UNINSTALL){
				rm -f $i
			}
		}
		if not {
			$UNINSTALLCMD
		}
	}

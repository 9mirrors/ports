#!/bin/rc
. /sys/ports/Config/ports.conf
. /sys/ports/Mk/pkg.rc

if(~ $#1 0){
	echo 'Usage: port/db [command] [arguments]
	exit 'usage'
}

if(! test -e /sys/ports/Config/ports.db){
	echo 'error: the ports database does not exist'
	echo 'to create it use ''touch /sys/ports/Config/ports.db'''
	exit 'no db'
}

$cmd=$1
shift
switch($cmd){
case 'check':
	pkgcheck $*
case 'register':
	pkgregister $*
case 'deregister':
	pkgderegister $*
case 'version':
	pkgversion $*
default:
	echo 'unknown command'
	exit 'unknown'
}

fn pkgcheck {
	if(~ $#1 0){
		echo 'Usage: port/db check portname'
		exit 'pkgcheck usage'
	}
	portname=$1
	if(! checkport $portname){
		echo 'pkg: port '^$portname^' not installed'
		exit 'not installed'
	}
	if not {
		echo 'pkg: port '^$portname^' is installed'
		exit ''
	}
}

fn pkgregister {
	if(~ $#1 0){
		echo 'Usage: port/db register portname [version]'
		exit 'pkgregister usage'
	}
	if(~ $#2 0){
		pkgvers=$2
	}
	if not {
		pkgvers='0'
	}
	portname=$1
	register $portname $pkgvers
	exit ''
}

fn pkgderegister {
	if(~ $#1 0){
		echo 'Usage: port/db deregister portname'
		exit 'pkgderegister usage'
	}
	deregister $1
}

fn pkgversion {
	if(~ $#1 0){
		echo 'Usage: port/db version portname'
		exit 'pkgversion usage'
	}
	portname=$1
	if(! portversion $portname){
		echo 'port is unversioned'
		exit 'pkgversion unversioned'
	}
	exit ''
}

